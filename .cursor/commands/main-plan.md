# Промпт для создания плана решения задачи

## Задача

Думай очень глубоко и многослойно. Не ограничивайся поверхностными ответами.
При каждом шаге анализа проверяй себя вопросами "почему?" и "а что если?". Ищи скрытые зависимости, потенциальные подводные камни и нетривиальные сценарии.

**ВАЖНО: Не пиши код на этом этапе. Только анализ и планирование.**

## Анализ задачи

1. Проанализируй задачу / сервис.
2. Опиши назначение, основные входные и выходные данные.
3. Выдели ключевые компоненты, которые нужно реализовать или изменить.
4. Укажи возможные риски, узкие места и зависимости.
5. Определи, какие стандарты проекта будут затронуты:
   - Код (STANDART_CODE.md)
   - Проект (STANDART_PROJECT.md)
   - Тесты (STANDART_TEST.md)
   - JavaDoc (STANDART_JAVADOC.md)
   - Swagger/OpenAPI (STANDART_SWAGGER.md)
   - README (STANDART_README.md)
   - Postman (STANDART_POSTMAN.md)

## Составление плана

Составь пошаговый план выполнения задачи, разделив на следующие этапы:

### 1. Анализ и проектирование
- Анализ требований и существующего кода
- Проектирование API (если добавляются новые эндпоинты)
- Проектирование структуры данных (DTO, Entity)
- Определение зависимостей между компонентами

### 2. Реализация кода
**Обязательно учитывай стандарты:**
- **STANDART_CODE.md**: 
  - Использование Java 24 features (Records для DTO, text blocks, pattern matching)
  - Следование архитектурным паттернам (layered architecture, API interface separation)
  - Использование MapStruct для маппинга
  - Правильная структура пакетов
  - Использование Lombok (@Slf4j, @RequiredArgsConstructor)
  - Bean Validation на DTO
  - Exception handling через GlobalExceptionHandler
  
- **STANDART_PROJECT.md**:
  - Использование @LoggableRequest для всех методов контроллера
  - Скрытие чувствительных полей в @LoggableRequest(hideFields = {...})
  - Использование исключений из common-lib (UniquenessValidationException, BusinessRuleValidationException, FormatValidationException)
  - Размещение shared DTOs в common-lib/dto
  - Размещение shared enums в common-lib/enums

**Компоненты для реализации:**
- Entity (если нужна новая)
- DTO (Request, Response, Filter) - использовать Records
- Mapper (MapStruct interface)
- Repository (если нужен новый)
- Validator (interface + implementation)
- Service (interface + implementation)
- Controller (если добавляются новые эндпоинты)

### 3. Документация кода (JavaDoc)
**Обязательно учитывай STANDART_JAVADOC.md:**
- JavaDoc для всех public классов и методов
- Обязательные теги: @author geron, @version 1.0
- @param для всех параметров
- @return для возвращаемых значений
- @throws для исключений
- JavaDoc для DTO Records с @param для всех компонентов
- **НЕ документировать** Derived Query Methods в Repository
- Использовать @see для методов-реализаций интерфейсов

### 4. Тестирование
**Обязательно учитывай STANDART_TEST.md:**

#### Unit тесты:
- Тесты для Service implementations
- Тесты для Validators
- Тесты для Mappers (использовать реальный маппер, не мок)
- Тесты для Utility classes
- Тесты для Gateways

**Требования к unit тестам:**
- Использовать @ExtendWith(MockitoExtension.class)
- Именование: `methodName_WhenCondition_ShouldExpectedResult`
- Использовать @Nested для группировки тестов
- Использовать AssertJ для assertions
- Следовать паттерну AAA (Arrange-Act-Assert)
- Проверять все успешные и ошибочные сценарии
- Проверять взаимодействия с зависимостями (verify)

#### Integration тесты:
**Обязательно, если добавляются новые эндпоинты в контроллерах:**
- Тесты для всех новых эндпоинтов контроллера
- Использовать @SpringBootTest, @AutoConfigureWebMvc
- Использовать MockMvc для тестирования REST endpoints
- Использовать WireMock для мокирования внешних сервисов (если есть интеграции)
- Использовать @Transactional для изоляции тестов
- Тестировать все возможные статус-коды (200, 201, 400, 404, 409)
- Проверять валидацию запросов
- Проверять формат ответов

### 5. Swagger/OpenAPI документация
**Обязательно, если добавляются новые эндпоинты в контроллерах.**
**Учитывай STANDART_SWAGGER.md:**

- Создать/обновить OpenAPI interface (*Api.java) с @Tag
- Добавить @Operation для каждого метода с summary и description
- Добавить @ApiResponses со всеми возможными статус-кодами
- Добавить @ExampleObject для успешных и ошибочных ответов
- Добавить @Parameter для всех параметров
- Добавить @Schema на уровне класса DTO (name, description, example)
- Добавить @Schema для всех полей DTO (description, example, requiredMode, format, minLength, maxLength)
- Использовать RFC 7807 Problem Details для ошибок
- Обновить OpenApiConfig если нужно (добавить новые серверы, обновить описание)

### 6. Обновление README
**Обязательно учитывай STANDART_README.md:**
- Обновить раздел "Основные возможности" (если добавлена новая функциональность)
- Обновить раздел "REST API" (если добавлены новые эндпоинты):
  - Добавить новые эндпоинты в таблицу
  - Добавить детальное описание новых эндпоинтов
- Обновить раздел "Бизнес-логика" (если добавлены новые методы сервиса)
- Обновить раздел "Слой валидации" (если добавлена новая валидация)
- Обновить раздел "Работа с базой данных" (если добавлены новые таблицы/поля)
- Обновить раздел "Примеры использования" (добавить примеры для новых эндпоинтов)
- **Все README файлы должны быть на русском языке**

### 7. Postman коллекции
**Обязательно, если добавляются новые эндпоинты в контроллерах.**
**Учитывай STANDART_POSTMAN.md:**

- Добавить новые запросы в коллекцию
- Именование запросов: lowercase с пробелами (например: "create user", "get user by id")
- Использовать переменную {{baseUrl}} для базового URL
- Использовать переменные окружения для path параметров ({{userId}}, {{tweetId}})
- Добавить описания для всех запросов
- Добавить примеры ответов для всех сценариев:
  - Успешные ответы (200, 201)
  - Ошибки валидации (400)
  - Ресурс не найден (404)
  - Конфликты (409)
- Использовать правильный Content-Type:
  - `application/json` для успешных ответов
  - `application/problem+json` для ошибок
- Следовать RFC 7807 Problem Details для ошибок
- Обновить переменные окружения если нужно

### 8. Проверка соответствия стандартам
- Проверить соответствие STANDART_CODE.md
- Проверить соответствие STANDART_PROJECT.md
- Проверить соответствие STANDART_TEST.md
- Проверить соответствие STANDART_JAVADOC.md
- Проверить соответствие STANDART_SWAGGER.md (если добавлены эндпоинты)
- Проверить соответствие STANDART_README.md
- Проверить соответствие STANDART_POSTMAN.md (если добавлены эндпоинты)

## Формат плана (TODO.md)

Сохрани результат в файл `todo/TODO.md` (или `todo/TODO_[название_задачи].md`).

Структурируй файл в виде чек-листа с разделением на "Done / In Progress / To Do" (по kanban-подходу).
Добавь приоритеты (P1, P2, P3).

### Шаблон TODO

```markdown
# TODO: [Название задачи]

## Meta
- project: twitter-microservices
- updated: YYYY-MM-DD
- changelog: todo/CHANGELOG.md
- standards:
  - STANDART_CODE.md
  - STANDART_PROJECT.md
  - STANDART_TEST.md
  - STANDART_JAVADOC.md
  - STANDART_SWAGGER.md (если добавляются эндпоинты)
  - STANDART_README.md
  - STANDART_POSTMAN.md (если добавляются эндпоинты)

## Tasks

### Анализ и проектирование
- [ ] (P1) #1: Анализ требований — Краткое описание.
  acceptance: "Понять вход/выход, non-functional requirements, определить затронутые стандарты"
- [ ] (P1) #2: Проектирование API и контрактов — Краткое описание.
  acceptance: "OpenAPI схема, DTO структура, Entity структура (если нужна)"

### Реализация кода
- [ ] (P1) #3: Реализация Entity (если нужна) — Краткое описание.
  acceptance: "Entity создана с учетом STANDART_CODE.md"
- [ ] (P1) #4: Реализация DTO (Records) — Краткое описание.
  acceptance: "Все DTO созданы как Records с валидацией, размещены в правильных пакетах"
- [ ] (P1) #5: Реализация Mapper (MapStruct) — Краткое описание.
  acceptance: "Mapper интерфейс создан с правильными маппингами"
- [ ] (P1) #6: Реализация Repository — Краткое описание.
  acceptance: "Repository создан с Derived Query Methods (без JavaDoc)"
- [ ] (P1) #7: Реализация Validator — Краткое описание.
  acceptance: "Validator interface и implementation созданы, используют исключения из common-lib"
- [ ] (P1) #8: Реализация Service — Краткое описание.
  acceptance: "Service interface и implementation созданы, используют @Transactional где нужно"
- [ ] (P1) #9: Реализация Controller — Краткое описание.
  acceptance: "Controller создан с @LoggableRequest, использует @Valid, реализует *Api интерфейс"

### Документация кода (JavaDoc)
- [ ] (P1) #10: JavaDoc для всех классов — Краткое описание.
  acceptance: "Все public классы и методы имеют JavaDoc с @author geron, @version 1.0"
- [ ] (P1) #11: JavaDoc для DTO — Краткое описание.
  acceptance: "Все DTO Records имеют JavaDoc с @param для всех компонентов"

### Тестирование
- [ ] (P1) #12: Unit тесты для Service — Краткое описание.
  acceptance: "Все методы Service покрыты unit тестами с учетом STANDART_TEST.md"
- [ ] (P1) #13: Unit тесты для Validator — Краткое описание.
  acceptance: "Все методы Validator покрыты unit тестами"
- [ ] (P1) #14: Unit тесты для Mapper — Краткое описание.
  acceptance: "Mapper протестирован с реальным маппером (не мок)"
- [ ] (P2) #15: Integration тесты для Controller — Краткое описание.
  acceptance: "Все новые эндпоинты покрыты integration тестами с MockMvc, все статус-коды проверены"

### Swagger/OpenAPI документация
- [ ] (P1) #16: OpenAPI interface (*Api.java) — Краткое описание.
  acceptance: "Создан/обновлен *Api.java с @Tag, @Operation, @ApiResponses, @Parameter"
- [ ] (P1) #17: DTO Schema аннотации — Краткое описание.
  acceptance: "Все DTO имеют @Schema на уровне класса и полей с учетом STANDART_SWAGGER.md"
- [ ] (P2) #18: Обновление OpenApiConfig — Краткое описание.
  acceptance: "OpenApiConfig обновлен если нужно (новые серверы, описание)"

### Обновление README
- [ ] (P2) #19: Обновление README.md — Краткое описание.
  acceptance: "README обновлен с учетом STANDART_README.md, все новые эндпоинты документированы"

### Postman коллекции
- [ ] (P2) #20: Обновление Postman коллекции — Краткое описание.
  acceptance: "Добавлены все новые запросы с примерами ответов, обновлены переменные окружения"

### Проверка соответствия стандартам
- [ ] (P1) #21: Проверка соответствия стандартам — Краткое описание.
  acceptance: "Все стандарты проверены, код соответствует требованиям"

## Assumptions
- Список принятых предположений
- Например: "Предполагается, что пользователь уже существует при создании твита"

## Risks
- Технические риски
- Организационные риски
- Зависимости от других сервисов/компонентов

## Metrics & Success Criteria
- Метрики для оценки успешности реализации
- Критерии приемки
- Например: "Все тесты проходят, покрытие кода > 80%"

## Notes
- Примечания и ссылки
- Ссылки на стандарты
- Ссылки на связанные задачи
```

## При формировании плана обязательно

1. **Думай как архитектор, тимлид и DevOps одновременно:**
   - Учитывай масштабируемость решения
   - Продумывай интеграции между сервисами
   - Учитывай производительность и безопасность

2. **Предусмотри как технические, так и организационные риски:**
   - Технические: зависимости, производительность, безопасность
   - Организационные: сроки, ресурсы, знания команды

3. **Отрази, какие метрики и критерии успешности будут использоваться:**
   - Покрытие тестами
   - Соответствие стандартам
   - Производительность (если применимо)
   - Качество кода

4. **Заложи шаги на ретроспективу и улучшение процессов:**
   - Анализ проделанной работы
   - Выявление улучшений
   - Обновление документации при необходимости

5. **Учитывай все стандарты проекта:**
   - Всегда проверяй соответствие кода стандартам
   - Документируй согласно стандартам
   - Тестируй согласно стандартам
   - Обновляй документацию согласно стандартам

## Важные напоминания

- **Не пиши код на этапе планирования** - только анализ и план
- **Всегда учитывай стандарты проекта** - они обязательны для соблюдения
- **Если добавляются новые эндпоинты** - обязательно:
  - Integration тесты
  - Swagger документация
  - Postman коллекции
- **Все README на русском языке**
- **Все JavaDoc на английском языке**
- **Все Swagger документация на английском языке**

